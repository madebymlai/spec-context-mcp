{
  "id": "snapshot_1770315403828_a9p9xpbq0",
  "approvalId": "approval_1770315403827_68cq5rv4c",
  "approvalTitle": "Design: Discipline Workflow Enhancement",
  "version": 1,
  "timestamp": "2026-02-05T18:16:43.828Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Discipline Workflow\n\n## Overview\n\nThis feature adds development discipline enforcement to spec-context-mcp through three new MCP tools (`get-implementer-guide`, `get-reviewer-guide`, `get-brainstorm-guide`) and enhancements to the existing `spec-workflow-guide`. It also introduces a new `principles.md` steering document type and configurable discipline modes via environment variables.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- New tools follow existing MCP tool patterns in `src/tools/workflow/`\n- TypeScript with MCP SDK types (`Tool`, `ToolResponse`)\n- Handlers return structured `ToolResponse` objects\n- Reuse existing `getSteeringDocsContent()` pattern for loading steering docs\n\n### Project Structure (structure.md)\n- New tools in `src/tools/workflow/` alongside existing tools\n- New template in `src/templates/principles-template.md`\n- Environment variable handling in `src/server.ts`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`getSteeringDocsContent()`** in `spec-workflow-guide.ts`: Extend to include `principles.md`\n- **`ToolResponse` type** in `workflow-types.ts`: Use for all new tool handlers\n- **Template loading pattern**: Follow existing template file structure\n\n### Integration Points\n- **`spec-workflow-guide.ts`**: Add brainstorm option, discipline-aware content\n- **`steering-guide.ts`**: Add `principles.md` to steering workflow\n- **`src/templates/`**: Add `principles-template.md`\n- **Environment variables**: Read from `process.env` in server initialization\n\n## Architecture\n\n### Modular Design Principles\n- **Single File Responsibility**: Each guide tool in its own file\n- **Component Isolation**: Guide content generators are pure functions\n- **Service Layer Separation**: Tool definitions separate from handlers\n\n```mermaid\ngraph TD\n    subgraph \"Environment\"\n        ENV[SPEC_CONTEXT_DISCIPLINE]\n        ENV_IMP[SPEC_CONTEXT_IMPLEMENTER]\n        ENV_REV[SPEC_CONTEXT_REVIEWER]\n        ENV_BRAIN[SPEC_CONTEXT_BRAINSTORM]\n    end\n\n    subgraph \"MCP Tools\"\n        SWG[spec-workflow-guide]\n        IMG[get-implementer-guide]\n        RVG[get-reviewer-guide]\n        BRG[get-brainstorm-guide]\n    end\n\n    subgraph \"Steering Docs\"\n        PROD[product.md]\n        TECH[tech.md]\n        STRUCT[structure.md]\n        PRINC[principles.md]\n    end\n\n    subgraph \"Superpowers Content\"\n        TDD[TDD Rules]\n        VER[Verification Rules]\n        REV[Review Checklist]\n        BRAIN[Brainstorm Methodology]\n    end\n\n    ENV --> SWG\n    ENV --> IMG\n    ENV --> RVG\n\n    SWG --> PROD\n    SWG --> TECH\n    SWG --> STRUCT\n    SWG --> PRINC\n\n    IMG --> TECH\n    IMG --> PRINC\n    IMG --> TDD\n    IMG --> VER\n\n    RVG --> TECH\n    RVG --> PRINC\n    RVG --> REV\n\n    BRG --> BRAIN\n```\n\n## Components and Interfaces\n\n### Component 1: get-implementer-guide Tool\n- **Purpose:** Return discipline-specific implementation guidance\n- **Interfaces:**\n  ```typescript\n  export const getImplementerGuideTool: Tool\n  export async function getImplementerGuideHandler(args: any, context: ToolContext): Promise<ToolResponse>\n  ```\n- **Dependencies:** `workflow-types.ts`, steering doc loader\n- **Reuses:** `getSteeringDocsContent()` pattern\n\n### Component 2: get-reviewer-guide Tool\n- **Purpose:** Return review criteria and project standards\n- **Interfaces:**\n  ```typescript\n  export const getReviewerGuideTool: Tool\n  export async function getReviewerGuideHandler(args: any, context: ToolContext): Promise<ToolResponse>\n  ```\n- **Dependencies:** `workflow-types.ts`, steering doc loader\n- **Reuses:** `getSteeringDocsContent()` pattern\n\n### Component 3: get-brainstorm-guide Tool\n- **Purpose:** Return brainstorming methodology for pre-spec ideation\n- **Interfaces:**\n  ```typescript\n  export const getBrainstormGuideTool: Tool\n  export async function getBrainstormGuideHandler(args: any, context: ToolContext): Promise<ToolResponse>\n  ```\n- **Dependencies:** `workflow-types.ts`\n- **Reuses:** None (internal use, no steering docs)\n\n### Component 4: Discipline Configuration\n- **Purpose:** Read and validate discipline mode from environment\n- **Interfaces:**\n  ```typescript\n  type DisciplineMode = 'full' | 'standard' | 'minimal'\n  function getDisciplineMode(): DisciplineMode\n  function getDispatchCli(role: 'implementer' | 'reviewer' | 'brainstorm'): string | null\n  ```\n- **Dependencies:** `process.env`\n- **Location:** `src/config/discipline.ts` or inline in server.ts\n\n### Component 5: Steering Doc Loader Enhancement\n- **Purpose:** Load steering docs including new `principles.md`\n- **Interfaces:**\n  ```typescript\n  function getSteeringDocsContent(projectPath: string): {\n    product?: string;\n    tech?: string;\n    structure?: string;\n    principles?: string;\n  } | null\n  ```\n- **Dependencies:** `fs`, `path`\n- **Reuses:** Existing function, extended\n\n## Data Models\n\n### DisciplineConfig\n```typescript\ninterface DisciplineConfig {\n  mode: 'full' | 'standard' | 'minimal';\n  implementerCli: string | null;\n  reviewerCli: string | null;\n  brainstormCli: string | null;\n}\n```\n\n### GuideResponse\n```typescript\ninterface GuideResponse extends ToolResponse {\n  data: {\n    guide: string;           // The methodology content\n    steering?: {             // Auto-imported steering docs\n      tech?: string;\n      principles?: string;\n    };\n    disciplineMode: string;  // Current mode for reference\n    searchGuidance?: string; // MCP search tool usage\n  };\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Missing required steering docs**\n   - **Handling:** Return error response with instructions to create via `steering-guide`\n   - **User Impact:** Clear message: \"Required steering doc 'principles.md' not found. Create it first using the steering-guide tool.\"\n\n2. **Invalid discipline mode**\n   - **Handling:** Log warning, default to `full`\n   - **User Impact:** None (graceful default)\n\n3. **Missing steering directory**\n   - **Handling:** Return error for implementer/reviewer guides\n   - **User Impact:** Clear message directing to steering creation\n\n## Testing Strategy\n\n### Unit Testing\n- Test each guide returns correct content for each discipline mode\n- Test steering doc loading with missing/present files\n- Test environment variable parsing with valid/invalid values\n- Test fail-fast behavior for missing required docs\n\n### Integration Testing\n- Test full workflow: spec-workflow-guide → brainstorm → implementer → reviewer\n- Test discipline mode affects task generation\n- Test steering doc content properly embedded in responses\n\n### End-to-End Testing\n- Test CLI dispatch invocation pattern\n- Test review loop with issue detection\n- Test orchestrator takeover on repeated issues\n\n## File Changes\n\n### New Files\n- `src/tools/workflow/get-implementer-guide.ts`\n- `src/tools/workflow/get-reviewer-guide.ts`\n- `src/tools/workflow/get-brainstorm-guide.ts`\n- `src/templates/principles-template.md`\n- `src/config/discipline.ts` (optional, could be inline)\n\n### Modified Files\n- `src/tools/workflow/spec-workflow-guide.ts` - Add brainstorm option, discipline logic\n- `src/tools/workflow/steering-guide.ts` - Add principles.md to workflow\n- `src/tools/workflow/index.ts` - Export new tools\n- `src/tools/index.ts` - Register new tools\n- `src/server.ts` - Read discipline env vars\n- `src/templates/tech-template.md` - Remove principles section (moved to principles.md)\n\n## Guide Content Sources\n\nEach guide's methodology content is adapted from Superpowers Skills:\n\n| Guide | Source Skill | Key Content |\n|-------|--------------|-------------|\n| `get-implementer-guide` (full) | `test-driven-development` | Red-green-refactor, iron law, rationalizations |\n| `get-implementer-guide` (all) | `verification-before-completion` | Gate function, evidence before claims |\n| `get-implementer-guide` (all) | `receiving-code-review` | Feedback handling, push back guidance |\n| `get-reviewer-guide` | `requesting-code-review` | Review checklist, severity levels |\n| `get-brainstorm-guide` | `brainstorming` | Question-driven exploration, trade-offs |\n\nContent is copied and adapted with:\n- References to `principles.md` and `tech.md` steering docs\n- MCP tool names and workflow\n- `SPEC_CONTEXT_DISCIPLINE` mode logic\n- LLM-agnostic language (no Claude-specific references)\n",
  "fileStats": {
    "size": 8255,
    "lines": 242,
    "lastModified": "2026-02-05T18:16:38.188Z"
  },
  "comments": []
}